---
title: 'ACID特性のCについて語る'
date: '2021-05-22'
description: 'ACID特性のCについて語る'
tags: ['DataBase','SQL']
---

## はじめに
DBのトランザクションにはACIDと呼ばれる満たすべき4つの特性がある。すなわちAtomicity(原子性)・Consistency(一貫性)・Isolation(隔離性)・Durability(永続性)である。AIDは定義が明瞭なのに一貫性だけ腑に落ちないという経験は誰もが通る道だと思う。この記事では、なぜ腑に落ちないのかの理由をを考えたあと、明瞭な定義を与えようと思う。


## 一貫性がわかりにくい理由
* 大体の書籍等で一貫性の定義の中で一貫性という言葉を用いているのでなんの説明にもなっていないから(ある事柄を述べるのに同語を用いる修辞技法をトートロジーという)。
* ACIDの中でC(一貫性)だけビジネスサイドで保証するべき要求という点で他とは毛色が違うのにそのことの言及がないから。

「ACID特性」とググって1ページ目を見比べてみた。

ひとつめの例でいうと、ほとんどすべてのサイトで「一貫性」ないし「整合性」という言葉を使っている。例えばWikipediaのACID特性のページ[1]では以下のように表記してある。

> 日本語では一貫性あるいは整合性とも呼ばれる。トランザクション開始と終了時にあらかじめ与えられた整合性を満たすことを保証する性質を指す。 

トランザクションにおける整合性とは、トランザクションで、与えられた整合性を満たすことらしい。

結局整合性とは何かという問いに答えていないのである。

ふたつめの例としてこのサイト[2]を引用する。

> 一貫性とは、整合性がとれたデータベースでは、トランザクション実行後も整合性がとれるという性質のことです。
> もう少し簡単な言い方をすれば、データベースのルールはどのようなトランザクションがあっても破られないということです。
> 例えばお父さんから子供へおこづかいを渡した時に、それぞれのおこづかいの合計額に誤りがでてしまったり、「－3000円のおこづかいを渡す」というようなあり得ない処理をすることがないようにする性質です。

「-3000円のおこづかいを渡す」というようなあり得ない処理とのことだが、これは"データベースのルール"なのだろうか。そもそもデータベースのルールとはなんなのだろう。何がありえないんだろう。「－3000円のおこづかいを渡す」というのは「3000円のおこづかいを徴収する」ということはこれはこれで筋が通っているのではないのか。

ということを考えてしまってやっぱりどうしても納得の行くものではないと思う。


## Acasune流解説

結局上2つの疑問が解決したことで僕は理解が明瞭になったし、読者の助けになると思って書いてみる。

2つめの疑問はもうすでに答えをほとんど書いてしまっているのでこちらから解説する。

結局のところ整合性を定めるのは決してDBなどではなく、ビジネスサイドである。上のお小遣いで親が徴収するというルールが提供するアプリケーションで明瞭に語られていれば、「－3000円のおこづかいを渡す」という処理もまた整合的であると言えるし、許さないということであれば処理するべきエラーであるといえる。

Martin(2019)[3]という名著がある。この記事を書く直接的なモチベーションになった本だが、こちらでは上記のことが明瞭に語られている。P243から引用する。太字はAcasune編集です。(ここのページの含蓄は深いのでぜひご購入いただいてお読みいただきたい...。)

> ACIDにおける一貫性という概念は、データについて常に真でなければならない何らかの言明(不変性)があるということです。
> (中略)
> とはいえ、この一貫性の概念はアプリケーション固有の普遍性の概念に依存しており、一貫性を保つようにトランザクションを適切に定義することは**アプリケーションの責任になります**
> これはデータベースが保証できることではありません。アプリケーションが普遍性に違反する悪いデータを書き込んだとしても、データベースはそれを止めることはできません。

こう書かれている通り、Consistencyは基本的にはアプリケーション側でチャッチするべきものであり、データベースのルールなどではないはずである。(もちろん非null制約等をかけることである程度の検査は可能だが、本質的にはアプリケーション側でキャッチするべきである。)

1つ目の解説も上の引用でほとんど答えが出てしまっている。すなわち
> データについて常に真でなければならない何らかの言明

というのがConcistencyの持つ言葉の本質である。

せっかくなのでもう少し深堀りして解説してみる。
トランザクションを一段抽象的な目線で眺めてみると、トランザクションはデータベースの状態を遷移させる契機であると捉えることができる。遷移後の状態の数(濃度)がたくさんある中で、その中でも**ビジネス的に**許される状態と許されない状態を定義することができる。例えば上の例でいうと「おこづかいを与える」という命令によって子供の残高が減算されるという状態もDB的には可能だが、これは許されない(とビジネス目線定義されている)状態である。このビジネス的に許される状態と許されない状態を無数に考えられる中で、トランザクション以前の状態は一貫して前者の状態であり、トランザクション直後の状態もやはり前者の状態を保証しようねというのがConsistencyという言葉が真に意味することだと思う。

以上を踏まえて僕が考えた定義を記述して本記事を終了とする。

> Concistencyとは、トランザクション処理の結果がシステム要求(≒ビジネスルール)を常に満足することを保証しなければならないという性質である。

## おまけ

やはりMartin(2019)[3]は含蓄に富む。P243には他にも示唆に富む記述があるので最後に何個か引用して終わる。

>ある種の普遍性の中には、例えば外部キーの制約やユニーク制約を使ってデータベースがチェックできるものがあります。しかし一般的には、データ適正かどうかは、データが適正かどうかはアプリケーションが決めることであり、データベースはデータを保存するだけです

> 原子性、分離性、永続性はデータベースの特性ですが、一貫性は(ACIDという考え方においては)アプリケーションの特性です。アプリケーションは一貫性を保つ上で、データベースの原子性や分離性といった特性を頼りにできますが、一貫性を保つことはデータベースだけの責任ではありません。したがって、Cは実際にはACIDに属していないのです。


## 参考文献
[1] [ACID (コンピュータ科学) - Wikipedia](https://ja.wikipedia.org/wiki/ACID_(%E3%82%B3%E3%83%B3%E3%83%94%E3%83%A5%E3%83%BC%E3%82%BF%E7%A7%91%E5%AD%A6))  
[2] [トランザクションのACID特性とは何か？](https://ssaits.jp/promapedia/technology/acid.html)  
[3] [データ指向アプリケーションデザイン ―信頼性、拡張性、保守性の高い分散システム設計の原理](https://amzn.to/3buP8FS)  
